# StarDeck Design Document

## Overview

StarDeck is a Python-native presentation framework - "Slidev for Python". It uses StarHTML and Datastar for reactive, hypermedia-driven slides with server-side Python execution.

## Core Principles

1. **Hypermedia-Driven**: Server determines slide state; Datastar swaps fragments
2. **Motion-First**: Animations via Motion.dev and Flubber plugins
3. **Zero-Config**: `stardeck run slides.md` is all you need
4. **Event-Driven**: Same animation definitions work for interactive and video export

## Data Model

```python
# stardeck/models.py
from dataclasses import dataclass, field
from pathlib import Path
from typing import Any

@dataclass(frozen=True)
class SlideInfo:
    content: str
    raw: str
    index: int
    start_line: int
    end_line: int
    frontmatter: dict[str, Any] = field(default_factory=dict)
    note: str | None = None
    title: str | None = None

    @property
    def layout(self) -> str:
        return self.frontmatter.get("layout", "default")

    @property
    def transition(self) -> str:
        return self.frontmatter.get("transition", "fade")

    @property
    def background(self) -> str | None:
        return self.frontmatter.get("background")

@dataclass(frozen=True)
class DeckConfig:
    title: str = "Untitled"
    theme: str = "default"
    aspect_ratio: str = "16/9"
    transition: str = "slide-left"
    code_theme: str = "github-dark"

@dataclass
class Deck:
    slides: list[SlideInfo]
    config: DeckConfig
    filepath: Path
    raw: str

    @property
    def total(self) -> int:
        return len(self.slides)
```

## Parser Design

```python
# stardeck/parser.py
from markdown_it import MarkdownIt
from mdit_py_plugins.front_matter import front_matter_plugin
from mdit_py_plugins.container import container_plugin
import yaml
from .models import SlideInfo, DeckConfig, Deck

def create_md() -> MarkdownIt:
    return (
        MarkdownIt("commonmark", {"html": True})
        .use(front_matter_plugin)
        .use(container_plugin, name="click")
        .use(container_plugin, name="notes")
        .enable("table")
    )

def split_slides(content: str) -> list[tuple[str, int, int]]:
    """Split markdown by --- delimiter, tracking line numbers."""
    lines = content.split("\n")
    slides, current, start = [], [], 0

    for i, line in enumerate(lines):
        if line.strip() == "---" and current:
            slides.append(("\n".join(current), start, i - 1))
            current, start = [], i + 1
        else:
            current.append(line)

    if current:
        slides.append(("\n".join(current), start, len(lines) - 1))

    return slides

def parse_frontmatter(raw: str) -> tuple[dict, str]:
    """Extract YAML frontmatter from slide content."""
    if not raw.startswith("---"):
        return {}, raw

    parts = raw.split("---", 2)
    if len(parts) < 3:
        return {}, raw

    try:
        fm = yaml.safe_load(parts[1]) or {}
        return fm, parts[2].strip()
    except yaml.YAMLError:
        return {}, raw

def extract_notes(content: str) -> tuple[str, str | None]:
    """Extract speaker notes from content."""
    if "<!--" not in content:
        return content, None

    import re
    match = re.search(r"<!--\s*notes?\s*\n?(.*?)\s*-->", content, re.DOTALL | re.IGNORECASE)
    if match:
        notes = match.group(1).strip()
        content = content[:match.start()] + content[match.end():]
        return content.strip(), notes
    return content, None

def parse_deck(filepath: Path) -> Deck:
    """Parse a markdown file into a Deck."""
    raw = filepath.read_text()
    md = create_md()

    # Extract global config from first slide if it's frontmatter-only
    raw_slides = split_slides(raw)
    config = DeckConfig()

    if raw_slides:
        first_fm, first_content = parse_frontmatter(raw_slides[0][0])
        if not first_content.strip() and first_fm:
            config = DeckConfig(**{k: v for k, v in first_fm.items() if hasattr(DeckConfig, k)})
            raw_slides = raw_slides[1:]

    slides = []
    for idx, (slide_raw, start, end) in enumerate(raw_slides):
        fm, content = parse_frontmatter(slide_raw)
        content, notes = extract_notes(content)

        # Extract title from first heading
        title = None
        for line in content.split("\n"):
            if line.startswith("# "):
                title = line[2:].strip()
                break

        slides.append(SlideInfo(
            content=md.render(content),
            raw=slide_raw,
            index=idx,
            start_line=start,
            end_line=end,
            frontmatter=fm,
            note=notes,
            title=title,
        ))

    return Deck(slides=slides, config=config, filepath=filepath, raw=raw)
```

## Renderer Design

```python
# stardeck/renderer.py
from starhtml import Div, Pre, Code, Span
from pygments import highlight
from pygments.lexers import get_lexer_by_name
from pygments.formatters import HtmlFormatter
from .models import SlideInfo, Deck

def render_code_block(code: str, language: str, theme: str = "github-dark") -> Div:
    """Render syntax-highlighted code using Pygments."""
    try:
        lexer = get_lexer_by_name(language)
    except:
        lexer = get_lexer_by_name("text")

    formatter = HtmlFormatter(style=theme, nowrap=True)
    highlighted = highlight(code, lexer, formatter)

    return Div(
        Pre(
            Code(highlighted, cls="language-" + language),
            cls="code-block overflow-x-auto p-4 rounded-lg bg-gray-900",
        ),
        cls="relative group",
    )

def render_slide(slide: SlideInfo, deck: Deck) -> Div:
    """Render a single slide with layout and styling."""
    layout = slide.layout
    transition = slide.transition or deck.config.transition
    background = slide.background

    # Build style dict for background
    style = {}
    if background:
        if background.startswith("#") or background.startswith("rgb"):
            style["background-color"] = background
        elif background.startswith("http") or background.startswith("/"):
            style["background-image"] = f"url({background})"
            style["background-size"] = "cover"
            style["background-position"] = "center"

    style_str = "; ".join(f"{k}: {v}" for k, v in style.items()) if style else None

    return Div(
        Div(
            slide.content,  # Pre-rendered HTML from markdown
            cls=f"slide-content layout-{layout}",
        ),
        id=f"slide-{slide.index}",
        cls=f"slide transition-{transition}",
        style=style_str,
        **{"data-slide-index": slide.index},
    )

def render_slide_thumbnail(slide: SlideInfo) -> Div:
    """Render a thumbnail for overview mode."""
    return Div(
        Div(
            Span(str(slide.index + 1), cls="slide-number"),
            Span(slide.title or f"Slide {slide.index + 1}", cls="slide-title truncate"),
            cls="thumbnail-header",
        ),
        Div(
            slide.content[:200] + "..." if len(slide.content) > 200 else slide.content,
            cls="thumbnail-preview",
        ),
        id=f"thumb-{slide.index}",
        cls="slide-thumbnail cursor-pointer hover:ring-2 hover:ring-blue-500",
        **{"data-slide-index": slide.index},
    )
```

## Server Design

```python
# stardeck/server.py
from pathlib import Path
from starhtml import *
from starhtml.datastar import js, get, evt
from .models import Deck
from .parser import parse_deck
from .renderer import render_slide, render_slide_thumbnail

def create_app(deck_path: Path, *, debug: bool = False) -> tuple:
    """Create StarDeck application."""
    deck = parse_deck(deck_path)

    app, rt = star_app(
        title=deck.config.title,
        hdrs=[
            Script(src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"),
            Style(DECK_STYLES),
        ],
    )

    @rt("/")
    def home():
        return Div(
            # Define signals
            (slide_index := Signal("slide_index", 0)),
            (total_slides := Signal("total_slides", deck.total)),
            (overview_mode := Signal("overview_mode", False)),
            (scale := Signal("scale", 1.0)),

            # Main presentation container
            Div(
                # Slide viewport
                Div(
                    render_slide(deck.slides[0], deck),
                    id="slide-content",
                    cls="slide-viewport",
                ),

                # Navigation controls
                Div(
                    Button(
                        "←",
                        data_on_click=get("/api/slide/prev"),
                        data_attr_disabled=slide_index == 0,
                        cls="nav-btn",
                    ),
                    Span(
                        data_text=slide_index + 1 + " / " + total_slides,
                        cls="slide-counter",
                    ),
                    Button(
                        "→",
                        data_on_click=get("/api/slide/next"),
                        data_attr_disabled=slide_index == total_slides - 1,
                        cls="nav-btn",
                    ),
                    cls="navigation-bar",
                ),

                # Overview grid (hidden by default)
                Div(
                    *[render_slide_thumbnail(s) for s in deck.slides],
                    id="overview-grid",
                    style="display: none",
                    data_show=overview_mode,
                    cls="overview-grid",
                ),

                id="deck-container",
                cls="deck-container",
            ),

            # Keyboard navigation (window-level)
            Span(
                data_on_keydown__window=js("""
                    if (evt.key === 'ArrowRight' || evt.key === ' ') {
                        @get('/api/slide/next')
                    } else if (evt.key === 'ArrowLeft') {
                        @get('/api/slide/prev')
                    } else if (evt.key === 'Escape' || evt.key === 'o') {
                        $overview_mode = !$overview_mode
                    }
                """),
                style="display: none",
            ),

            cls="stardeck-root",
        )

    @rt("/api/slide/next")
    @sse
    def next_slide(slide_index: Signal):
        current = int(slide_index) if slide_index else 0
        new_idx = min(current + 1, deck.total - 1)
        yield signals(slide_index=new_idx)
        yield elements(
            render_slide(deck.slides[new_idx], deck),
            "#slide-content",
        )

    @rt("/api/slide/prev")
    @sse
    def prev_slide(slide_index: Signal):
        current = int(slide_index) if slide_index else 0
        new_idx = max(current - 1, 0)
        yield signals(slide_index=new_idx)
        yield elements(
            render_slide(deck.slides[new_idx], deck),
            "#slide-content",
        )

    @rt("/api/slide/{idx}")
    @sse
    def go_to_slide(idx: int):
        idx = max(0, min(idx, deck.total - 1))
        yield signals(slide_index=idx)
        yield elements(
            render_slide(deck.slides[idx], deck),
            "#slide-content",
        )

    return app, rt, deck

DECK_STYLES = """
.stardeck-root {
    --slide-width: 960px;
    --slide-height: 540px;
    --aspect-ratio: 16/9;
}

.deck-container {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
    overflow: hidden;
}

.slide-viewport {
    width: var(--slide-width);
    height: var(--slide-height);
    background: white;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    position: relative;
}

.slide {
    width: 100%;
    height: 100%;
    padding: 3rem;
    display: flex;
    flex-direction: column;
}

.slide-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.layout-cover {
    justify-content: center;
    align-items: center;
    text-align: center;
}

.layout-default {
    justify-content: flex-start;
}

.layout-split-left,
.layout-split-right {
    flex-direction: row;
    gap: 2rem;
}

.navigation-bar {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 1rem;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 0.5rem;
    color: white;
}

.nav-btn {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0.25rem;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.nav-btn:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.1);
    border-color: white;
}

.nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.slide-counter {
    font-variant-numeric: tabular-nums;
    min-width: 4rem;
    text-align: center;
}

.overview-grid {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    padding: 2rem;
    overflow-y: auto;
}

.slide-thumbnail {
    aspect-ratio: 16/9;
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    padding: 0.5rem;
    font-size: 0.5rem;
    transform-origin: center;
    transition: transform 0.2s, box-shadow 0.2s;
}

.slide-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.thumbnail-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.slide-number {
    background: #333;
    color: white;
    padding: 0.1rem 0.3rem;
    border-radius: 0.2rem;
    font-size: 0.6rem;
}

/* Transitions */
.transition-fade {
    animation: fadeIn 0.3s ease-out;
}

.transition-slide-left {
    animation: slideInLeft 0.3s ease-out;
}

.transition-slide-right {
    animation: slideInRight 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInLeft {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideInRight {
    from { transform: translateX(-100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Code blocks */
.code-block {
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
}
"""
```

## CLI Design

```python
# stardeck/cli.py
import click
from pathlib import Path

@click.group()
def cli():
    """StarDeck - Presentations as Code"""
    pass

@cli.command()
@click.argument("slides", type=click.Path(exists=True, path_type=Path))
@click.option("--port", "-p", default=8000, help="Port to serve on")
@click.option("--host", "-h", default="127.0.0.1", help="Host to bind to")
@click.option("--reload", "-r", is_flag=True, help="Enable hot reload")
def run(slides: Path, port: int, host: str, reload: bool):
    """Run a presentation."""
    from .server import create_app
    from starhtml import serve

    app, rt, deck = create_app(slides, debug=reload)

    click.echo(f"Starting StarDeck on http://{host}:{port}")
    click.echo(f"Presenting: {deck.config.title}")
    click.echo(f"Slides: {deck.total}")

    serve(app, host=host, port=port, reload=reload)

@cli.command()
@click.argument("slides", type=click.Path(exists=True, path_type=Path))
@click.option("--output", "-o", type=click.Path(path_type=Path), help="Output directory")
def export(slides: Path, output: Path | None):
    """Export presentation to static HTML."""
    click.echo("Export not yet implemented")

if __name__ == "__main__":
    cli()
```

## Hot Reload Design

```python
# stardeck/watch.py
from pathlib import Path
from watchfiles import awatch
from starhtml.realtime import StarHTMLWithLiveReload

async def watch_deck(deck_path: Path, on_change):
    """Watch deck file for changes and trigger reload."""
    async for changes in awatch(deck_path):
        for change_type, path in changes:
            if Path(path) == deck_path:
                on_change()
```

## Presenter Mode Design

```python
# stardeck/presenter.py
from starhtml import *
from .models import Deck
from .renderer import render_slide

def create_presenter_view(deck: Deck) -> Div:
    """Create presenter view with current slide, next slide, notes, and timer."""
    return Div(
        # Define signals
        (slide_index := Signal("slide_index", 0)),
        (elapsed := Signal("elapsed", 0)),

        # Two-column layout
        Div(
            # Left: Current slide (large)
            Div(
                H3("Current", cls="text-sm text-gray-500 mb-2"),
                Div(
                    id="presenter-current",
                    cls="slide-preview current",
                ),
                cls="flex-1",
            ),

            # Right: Next slide + Notes
            Div(
                # Next slide preview
                Div(
                    H3("Next", cls="text-sm text-gray-500 mb-2"),
                    Div(
                        id="presenter-next",
                        cls="slide-preview next",
                    ),
                    cls="mb-4",
                ),

                # Speaker notes
                Div(
                    H3("Notes", cls="text-sm text-gray-500 mb-2"),
                    Div(
                        id="presenter-notes",
                        cls="notes-panel",
                    ),
                    cls="flex-1",
                ),
                cls="w-1/3 flex flex-col",
            ),
            cls="flex gap-4 flex-1",
        ),

        # Timer bar
        Div(
            Span(data_text=format_time(elapsed), cls="timer"),
            Span(
                data_text=slide_index + 1 + " / " + deck.total,
                cls="slide-counter",
            ),
            cls="timer-bar",
        ),

        # Timer update (runs every second)
        Span(
            data_on_interval__duration_1s=elapsed.add(1),
            style="display: none",
        ),

        cls="presenter-root",
    )

def format_time(seconds: Signal) -> str:
    """Format seconds as MM:SS (computed expression)."""
    return js(f"Math.floor({seconds.to_js()} / 60).toString().padStart(2, '0') + ':' + ({seconds.to_js()} % 60).toString().padStart(2, '0')")
```

## Project Structure

```
stardeck/
├── __init__.py
├── cli.py           # CLI entry point
├── models.py        # Data classes
├── parser.py        # Markdown parsing
├── renderer.py      # Slide rendering
├── server.py        # StarHTML application
├── presenter.py     # Presenter mode
├── watch.py         # Hot reload
├── layouts/         # Layout components
│   ├── __init__.py
│   ├── cover.py
│   ├── default.py
│   ├── split.py
│   └── code_focus.py
├── components/      # Reusable components
│   ├── __init__.py
│   ├── code_block.py
│   └── navigation.py
├── themes/          # Theme definitions
│   ├── __init__.py
│   ├── default.py
│   └── dark.py
└── transitions/     # Transition definitions
    ├── __init__.py
    ├── fade.py
    └── slide.py
```

## Dependencies

```toml
[project]
name = "stardeck"
version = "0.1.0"
dependencies = [
    "starhtml>=0.1.0",
    "markdown-it-py>=3.0.0",
    "mdit-py-plugins>=0.4.0",
    "pygments>=2.17.0",
    "pyyaml>=6.0",
    "watchfiles>=0.21.0",
    "click>=8.1.0",
]

[project.scripts]
stardeck = "stardeck.cli:cli"
```

## MVP Roadmap

### Phase 1: The Engine
- [ ] Markdown parser with --- delimiter
- [ ] Basic StarHTML server serving slides by index
- [ ] Datastar navigation (Next/Prev swapping HTML)
- [ ] Pygments syntax highlighting for code blocks

### Phase 2: The Experience
- [ ] Keyboard shortcuts (Arrows, Space, Escape)
- [ ] CSS transitions (Fade, Slide-in)
- [ ] URL hash synchronization
- [ ] Watch mode (hot reloading via watchfiles)

### Phase 3: The Polish
- [ ] Overview mode (grid view)
- [ ] Presenter mode (multi-window sync)
- [ ] Drawing tools
- [ ] `uv add stardeck` CLI tool
